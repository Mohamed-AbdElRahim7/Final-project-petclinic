name: 02 - Terraform Apply

# Ù…ØªÙ‰ ÙŠØ´ØªØºÙ„: Ø¹Ù†Ø¯ Push Ø¹Ù„Ù‰ main (Ø¨Ø¹Ø¯ Merge PR)
on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ AWS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªÙ†ØµÙŠØ¨ Terraform
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Terraform Init
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: terraform init
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 5: Terraform Apply
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸš€ Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ Starting Terraform Apply..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform apply -auto-approve -input=false
          echo ""
          echo "âœ… Terraform Apply Completed!"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Terraform Outputs
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Get Terraform Outputs
        id: outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Extracting Terraform Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)
          
          echo "bastion_ip=${BASTION_IP}" >> $GITHUB_OUTPUT
          echo "lb_dns=${LB_DNS}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Outputs Extracted:"
          echo "   â€¢ Bastion IP: ${BASTION_IP}"
          echo "   â€¢ Load Balancer DNS: ${LB_DNS}"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Outputs Ù„Ù„Ù€ Ansible
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Save Terraform Outputs for Ansible
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Saving Terraform Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p /tmp/terraform-outputs
          
          # Save each output separately
          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json
          terraform output -raw ssh_private_key > /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem
          
          echo "âœ… Outputs saved to /tmp/terraform-outputs/"
          ls -lh /tmp/terraform-outputs/
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø±ÙØ¹ Artifacts
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Upload Terraform Outputs as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs/
          retention-days: 7
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 9: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ¬Ù‡ÙŠØ² EC2
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: â³ Wait for EC2 Instances to Boot
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ Waiting for EC2 instances to boot..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "This takes approximately 3 minutes..."
          sleep 180
          echo "âœ… Wait completed!"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø§Ø®ØªØ¨Ø§Ø± SSH Ù„Ù„Ù€ Bastion
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”Œ Test Bastion SSH Connectivity
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Testing SSH to Bastion..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          ssh -i /tmp/terraform-outputs/petclinic-test-key.pem \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              ubuntu@${{ steps.outputs.outputs.bastion_ip }} \
              'echo "âœ… Bastion is reachable!"' || echo "âš ï¸ Bastion not ready yet"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 11: Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“‹ Display Infrastructure Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                    â•‘"
          echo "â•‘  âœ… Infrastructure Deployed Successfully!         â•‘"
          echo "â•‘                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Infrastructure Details:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â€¢ Bastion Public IP:    ${{ steps.outputs.outputs.bastion_ip }}"
          echo "â€¢ Load Balancer DNS:    ${{ steps.outputs.outputs.lb_dns }}"
          echo "â€¢ Masters:              3 nodes"
          echo "â€¢ Workers:              3 nodes"
          echo ""
          echo "ğŸ”‘ SSH Access:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ssh -i petclinic-test-key.pem ubuntu@${{ steps.outputs.outputs.bastion_ip }}"
          echo ""
          echo "ğŸ“¦ Artifacts:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â€¢ terraform-outputs (download from Actions tab)"
          echo "  - bastion_ip.txt"
          echo "  - lb_dns.txt"
          echo "  - master_ips.json"
          echo "  - worker_ips.json"
          echo "  - petclinic-test-key.pem"
          echo ""
          echo "ğŸ¯ Next Step:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Ansible provisioning will start automatically"
          echo ""
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Ø§Ù„Ø®Ø·ÙˆØ© 12: ØªØ´ØºÙŠÙ„ Ansible Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸš€ Trigger Ansible Provisioning
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: '03-ansible-provision.yml',
                ref: 'main'
              });
              
              console.log('âœ… Ansible workflow triggered successfully!');
              console.log('Monitor: https://github.com/${{ github.repository }}/actions');
            } catch (error) {
              console.log('âš ï¸ Failed to trigger Ansible workflow:', error.message);
              console.log('You can manually trigger it from GitHub Actions tab');
            }
