---
# ============================================
# Playbook 6: Create Kubernetes Namespaces
# Purpose: Setup dev, test, prod environments
# ============================================

- name: Create Kubernetes Namespaces with Policies
  hosts: first_master
  gather_facts: no
  become: yes
  
  tasks:
    - name: Check existing namespaces
      command: kubectl get namespaces -o json
      register: existing_namespaces
      changed_when: false

    - name: Parse existing namespaces
      set_fact:
        existing_ns_list: "{{ existing_namespaces.stdout | from_json | json_query('items[*].metadata.name') }}"

    - name: Display existing namespaces
      debug:
        msg: |
          ðŸ“‹ Existing namespaces:
          {{ existing_ns_list | join(', ') }}

    - name: Create namespace manifests
      template:
        src: "../templates/namespace.yml.j2"
        dest: "/tmp/{{ item.name }}-namespace.yml"
        mode: '0644'
      loop: "{{ k8s_namespaces }}"
      loop_control:
        loop_var: namespace
      when: item.name not in existing_ns_list

    - name: Apply namespace manifests
      command: kubectl apply -f /tmp/{{ item.name }}-namespace.yml
      loop: "{{ k8s_namespaces }}"
      when: item.name not in existing_ns_list
      register: ns_create

    - name: Display namespace creation output
      debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ ns_create.results }}"
      when: item.changed | default(false)

    - name: Label kube-system namespace for network policies
      command: >
        kubectl label namespace kube-system
        kubernetes.io/metadata.name=kube-system
        --overwrite
      changed_when: false

    - name: Get all namespaces with labels
      command: kubectl get namespaces --show-labels
      register: all_namespaces

    - name: Display all namespaces
      debug:
        msg: "{{ all_namespaces.stdout_lines }}"

    - name: Get resource quotas
      command: kubectl get quota --all-namespaces
      register: quotas

    - name: Display quotas
      debug:
        msg: "{{ quotas.stdout_lines }}"

    - name: Get limit ranges
      command: kubectl get limitrange --all-namespaces
      register: limits

    - name: Display limit ranges
      debug:
        msg: "{{ limits.stdout_lines }}"

    - name: Get network policies
      command: kubectl get networkpolicy --all-namespaces
      register: netpol

    - name: Display network policies
      debug:
        msg: "{{ netpol.stdout_lines }}"

    - name: Create ServiceAccount for each namespace
      shell: |
        kubectl create serviceaccount {{ item.name }}-admin \
          -n {{ item.name }} \
          --dry-run=client -o yaml | kubectl apply -f -
      loop: "{{ k8s_namespaces }}"

    - name: Create Role for namespace admin
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: rbac.authorization.k8s.io/v1
        kind: Role
        metadata:
          name: namespace-admin
          namespace: {{ item.name }}
        rules:
        - apiGroups: ["*"]
          resources: ["*"]
          verbs: ["*"]
        EOF
      loop: "{{ k8s_namespaces }}"

    - name: Create RoleBinding
      shell: |
        kubectl create rolebinding {{ item.name }}-admin-binding \
          --role=namespace-admin \
          --serviceaccount={{ item.name }}:{{ item.name }}-admin \
          -n {{ item.name }} \
          --dry-run=client -o yaml | kubectl apply -f -
      loop: "{{ k8s_namespaces }}"

    - name: Create context aliases script
      copy:
        content: |
          #!/bin/bash
          # Quick namespace switching aliases
          
          alias kdev='kubectl config set-context --current --namespace=dev && echo "âœ… Switched to dev namespace"'
          alias ktest='kubectl config set-context --current --namespace=test && echo "âœ… Switched to test namespace"'
          alias kprod='kubectl config set-context --current --namespace=prod && echo "âœ… Switched to prod namespace"'
          alias kdefault='kubectl config set-context --current --namespace=default && echo "âœ… Switched to default namespace"'
          
          # Show current namespace
          alias kcn='kubectl config view --minify | grep namespace | cut -d" " -f6'
          
          echo "Namespace aliases loaded! Use: kdev, ktest, kprod, kdefault, kcn"
        dest: /tmp/namespace-aliases.sh
        mode: '0755'

    - name: Fetch namespace aliases to bastion
      fetch:
        src: /tmp/namespace-aliases.sh
        dest: /tmp/namespace-aliases.sh
        flat: yes

  post_tasks:
    - name: Summary - Namespaces created
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  âœ… Namespaces Created Successfully!                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“Š Created Namespaces:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          {% for ns in k8s_namespaces %}
          â€¢ {{ ns.name }} ({{ ns.labels.environment }})
            - CPU Quota: {{ ns.resource_quota.cpu }}
            - Memory Quota: {{ ns.resource_quota.memory }}
            - Pods Quota: {{ ns.resource_quota.pods }}
          {% endfor %}
          
          ðŸ”’ Security Policies:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âœ… Resource Quotas: Applied
          âœ… Limit Ranges: Applied
          âœ… Network Policies: 
             - Default deny all
             - Allow DNS
             - Allow same namespace
             - Allow ingress controller
          âœ… RBAC: ServiceAccount + Role + RoleBinding created
          
          ðŸŽ¯ Quick Commands:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # Switch namespaces (add to ~/.bashrc)
          source /tmp/namespace-aliases.sh
          
          kdev    # Switch to dev
          ktest   # Switch to test
          kprod   # Switch to prod
          kcn     # Show current namespace
          
          # Check resources
          kubectl get all -n dev
          kubectl describe quota -n dev
          kubectl describe limitrange -n dev
          
          ðŸš€ Ready to deploy applications!