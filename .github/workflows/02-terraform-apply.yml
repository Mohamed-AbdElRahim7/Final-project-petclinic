name: 02 - Terraform Apply & Ansible Provision

on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'
  
  workflow_dispatch:

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      actions: write

    outputs:
      bastion_ip: ${{ steps.extract.outputs.bastion_ip }}
      lb_dns: ${{ steps.extract.outputs.lb_dns }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ§ª Test AWS Connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ§ª Testing AWS Connection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Initializing Terraform..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform init
          echo "âœ… Init completed!"

      - name: âœ… Terraform Validate
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Validating Configuration..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform validate
          echo "âœ… Validation passed!"

      - name: ðŸš€ Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Starting Terraform Apply..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform apply -auto-approve -input=false
          echo ""
          echo "âœ… Terraform Apply completed!"

      - name: ðŸ“Š Extract Terraform Outputs
        id: extract
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Extracting Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)
          
          echo "bastion_ip=${BASTION_IP}" >> $GITHUB_OUTPUT
          echo "lb_dns=${LB_DNS}" >> $GITHUB_OUTPUT
          
          echo "âœ… Outputs extracted:"
          echo "  â€¢ Bastion: ${BASTION_IP}"
          echo "  â€¢ LB: ${LB_DNS}"

      - name: ðŸ“¦ Save Terraform Outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¦ Saving Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p /tmp/terraform-outputs
          
          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json
          terraform output -raw ssh_private_key > /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem
          
          echo "âœ… Outputs saved!"
          ls -lh /tmp/terraform-outputs/

      - name: ðŸ“¦ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs/
          retention-days: 7

      - name: â³ Wait for EC2 Boot
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ Waiting for EC2 instances..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Waiting 3 minutes for:"
          echo "  â€¢ EC2 instances to boot"
          echo "  â€¢ User-data scripts to complete"
          echo "  â€¢ SSH service to start"
          sleep 180
          echo "âœ… Wait completed!"

      - name: ðŸ”Œ Test Bastion SSH
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”Œ Testing Bastion connectivity..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          ssh -i /tmp/terraform-outputs/petclinic-test-key.pem \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ubuntu@${{ steps.extract.outputs.bastion_ip }} \
            'echo "âœ… Bastion is reachable!"' || echo "âš ï¸ Bastion not ready yet"

      - name: ðŸ“‹ Infrastructure Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Infrastructure Deployed!          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Details:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â€¢ Bastion IP:    ${{ steps.extract.outputs.bastion_ip }}"
          echo "â€¢ Load Balancer: ${{ steps.extract.outputs.lb_dns }}"
          echo "â€¢ Masters:       3 nodes"
          echo "â€¢ Workers:       3 nodes"
          echo ""

  ansible-provision:
    name: Configure Kubernetes Cluster
    runs-on: ubuntu-latest
    needs: terraform-apply

    env:
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Ansible (Simple)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¦ Installing Ansible..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          pip install --upgrade pip
          pip install ansible
          
          echo ""
          echo "âœ… Ansible installed:"
          ansible --version

      - name: ðŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs

      - name: âœ… Verify Artifacts
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Verifying artifacts..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "ðŸ“¦ Downloaded files:"
          ls -lh /tmp/terraform-outputs/
          
          for file in bastion_ip.txt lb_dns.txt master_ips.json worker_ips.json petclinic-test-key.pem; do
            if [ ! -f "/tmp/terraform-outputs/$file" ]; then
              echo "âŒ Missing: $file"
              exit 1
            fi
            echo "  âœ… $file"
          done

      - name: ðŸ”‘ Setup SSH Key
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”‘ Setting up SSH..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p ~/.ssh
          cp /tmp/terraform-outputs/petclinic-test-key.pem ~/.ssh/
          chmod 400 ~/.ssh/petclinic-test-key.pem
          
          cat >> ~/.ssh/config <<EOF
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          echo "âœ… SSH configured!"

      - name: ðŸ“ Generate Complete Inventory
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“ Generating Ansible Inventory..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          MASTER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/master_ips.json | paste -sd ' ')
          WORKER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/worker_ips.json | paste -sd ' ')
          
          echo "Debug:"
          echo "  Bastion: $BASTION_IP"
          echo "  LB: $LB_DNS"
          echo "  Masters: $MASTER_IPS"
          echo "  Workers: $WORKER_IPS"
          
          if [ -z "$BASTION_IP" ] || [ -z "$LB_DNS" ] || [ -z "$MASTER_IPS" ] || [ -z "$WORKER_IPS" ]; then
            echo "âŒ Missing outputs!"
            exit 1
          fi
          
          cat > inventory/hosts.ini <<EOF
# ============================================
# Kubernetes Cluster Inventory
# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
# ============================================

[bastion]
bastion ansible_host=$BASTION_IP ansible_user=ubuntu

[masters]
EOF
          
          MASTER_INDEX=1
          for IP in $MASTER_IPS; do
              echo "master-$MASTER_INDEX ansible_host=$IP node_type=master node_index=$MASTER_INDEX" >> inventory/hosts.ini
              MASTER_INDEX=$((MASTER_INDEX + 1))
          done
          
          cat >> inventory/hosts.ini <<EOF

[workers]
EOF
          
          WORKER_INDEX=1
          for IP in $WORKER_IPS; do
              echo "worker-$WORKER_INDEX ansible_host=$IP node_type=worker node_index=$WORKER_INDEX" >> inventory/hosts.ini
              WORKER_INDEX=$((WORKER_INDEX + 1))
          done
          
          cat >> inventory/hosts.ini <<'EOF'

[first_master]
master-1

[other_masters]
master-2
master-3

[k8s_cluster:children]
masters
workers

[all:children]
bastion
k8s_cluster

[k8s_cluster:vars]
ansible_user=ubuntu
ansible_ssh_private_key_file=~/.ssh/petclinic-test-key.pem
ansible_python_interpreter=/usr/bin/python3
EOF
          
          cat >> inventory/hosts.ini <<EOF
ansible_ssh_common_args='-o ProxyCommand="ssh -W %h:%p -i ~/.ssh/petclinic-test-key.pem -o StrictHostKeyChecking=no ubuntu@$BASTION_IP"'

[masters:vars]
k8s_role=master

[workers:vars]
k8s_role=worker

[bastion:vars]
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
EOF
          
          sed -i "s|control_plane_endpoint:.*|control_plane_endpoint: \"$LB_DNS:6443\"|" inventory/group_vars/all.yml
          
          echo ""
          echo "âœ… Inventory generated!"

      - name: ðŸ‘ï¸ Show Inventory
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“‹ Generated Inventory:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cat inventory/hosts.ini

      - name: â³ Wait for User-Data
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ Waiting for user-data scripts..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Additional 2 minutes for Kubernetes components installation"
          sleep 120
          echo "âœ… Wait completed!"

      - name: ðŸ”Œ Test Connectivity
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”Œ Testing connectivity..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          ansible all -i inventory/hosts.ini -m ping || echo "âš ï¸ Some nodes not ready"

      - name: "âœ… Step 1/8: Verify Nodes"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Step 1/8: Verify Nodes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/01-verify-nodes.yml -i inventory/hosts.ini

      - name: "ðŸŽ¯ Step 2/8: Init First Master"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŽ¯ Step 2/8: Initialize First Master"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/02-init-first-master.yml -i inventory/hosts.ini

      - name: "ðŸ”— Step 3/8: Join Masters"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”— Step 3/8: Join Other Masters"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/03-join-masters.yml -i inventory/hosts.ini

      - name: "ðŸ‘· Step 4/8: Join Workers"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ‘· Step 4/8: Join Workers"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/04-join-workers.yml -i inventory/hosts.ini

      - name: "ðŸŒ Step 5/8: Install CNI"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸŒ Step 5/8: Install Calico CNI"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/05-install-cni.yml -i inventory/hosts.ini

      - name: "ðŸ“¦ Step 6/8: Create Namespaces"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¦ Step 6/8: Create Namespaces"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/06-create-namespaces.yml -i inventory/hosts.ini

      - name: "ðŸ–¥ï¸ Step 7/8: Setup Kubectl"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ–¥ï¸ Step 7/8: Setup kubectl on Bastion"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/07-setup-kubectl-bastion.yml -i inventory/hosts.ini

      - name: "ðŸ”€ Step 8/8: Install Ingress"
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ”€ Step 8/8: Install Ingress Controller"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          ansible-playbook playbooks/08-install-ingress-nginx.yml -i inventory/hosts.ini

      - name: ðŸ“¥ Fetch Kubeconfig
        working-directory: ansible-k8s-setup
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“¥ Fetching kubeconfig..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          
          scp -i ~/.ssh/petclinic-test-key.pem \
              -o StrictHostKeyChecking=no \
              ubuntu@${BASTION_IP}:~/.kube/config \
              /tmp/kubeconfig || echo "âš ï¸ Failed to fetch kubeconfig"

      - name: ðŸ“¦ Upload Kubeconfig
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: /tmp/kubeconfig
          retention-days: 7

      - name: ðŸŽ‰ Final Summary
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸŽ‰ Cluster Setup Complete!          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Cluster Info:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â€¢ Bastion:  $BASTION_IP"
          echo "â€¢ API:      $LB_DNS:6443"
          echo "â€¢ Masters:  3"
          echo "â€¢ Workers:  3"
          echo ""
          echo "ðŸ”‘ SSH Access:"
          echo "ssh -i petclinic-test-key.pem ubuntu@$BASTION_IP"
          echo ""
          echo "ðŸ“¦ Artifacts:"
          echo "â€¢ terraform-outputs"
          echo "â€¢ kubeconfig"
          echo ""
