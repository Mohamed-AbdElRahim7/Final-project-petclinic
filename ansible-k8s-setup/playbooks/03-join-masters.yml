---
- name: Join Other Masters to Cluster
  hosts: other_masters
  become: true
  gather_facts: true
  serial: 1

  tasks:
    - name: Check if node is already joined
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes | grep -q "{{ inventory_hostname }}" && echo "joined" || echo "not_joined"
      register: node_status
      changed_when: false
      failed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Display join status
      ansible.builtin.debug:
        msg: "Node {{ ansible_hostname }} is {{ 'already joined' if 'joined' in node_status.stdout else 'NOT joined' }}"

    - name: Skip if already joined
      ansible.builtin.meta: end_host
      when: "'joined' in node_status.stdout"

    - name: Generate new certificate key on first master
      ansible.builtin.shell: |
        kubeadm init phase upload-certs --upload-certs 2>/dev/null | tail -1
      register: cert_key
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Generate new join token on first master
      ansible.builtin.shell: |
        kubeadm token create --print-join-command
      register: join_token_output
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Get CA cert hash
      ansible.builtin.shell: |
        openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
        openssl rsa -pubin -outform der 2>/dev/null | \
        openssl dgst -sha256 -hex | sed 's/^.* //'
      register: ca_cert_hash
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Build complete join command
      ansible.builtin.set_fact:
        master_join_command: >-
          {{ join_token_output.stdout }}
          --control-plane
          --certificate-key {{ cert_key.stdout }}
          --apiserver-advertise-address {{ ansible_default_ipv4.address }}

    - name: Display join command
      ansible.builtin.debug:
        msg: "{{ master_join_command }}"

    - name: Join master to cluster
      ansible.builtin.shell: |
        {{ master_join_command }}
      register: join_result
      async: 600
      poll: 10
      retries: 3
      delay: 10
      until: join_result.rc == 0
      changed_when: true

    - name: Wait for node to be ready
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get node {{ ansible_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Label master node
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf label node {{ ansible_hostname }} node-role.kubernetes.io/control-plane='' --overwrite
        kubectl --kubeconfig=/etc/kubernetes/admin.conf label node {{ ansible_hostname }} node-role.kubernetes.io/master='' --overwrite
      delegate_to: "{{ groups['first_master'][0] }}"
      changed_when: true

    - name: Verify master joined successfully
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes {{ ansible_hostname }} -o wide
      register: verify_join
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Display verification
      ansible.builtin.debug:
        msg: "{{ verify_join.stdout_lines }}"
