name: 02 - Terraform Apply & Ansible Provision

on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'

  workflow_dispatch:

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "us-east-1"

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write
      actions: write

    outputs:
      bastion_ip: ${{ steps.extract.outputs.bastion_ip }}
      lb_dns: ${{ steps.extract.outputs.lb_dns }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Test AWS Connection
        run: aws sts get-caller-identity

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: terraform init

      - name: Terraform Validate
        working-directory: terraform-k8s-infrastructure
        run: terraform validate

      - name: Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: terraform apply -auto-approve -input=false

      - name: Extract Terraform Outputs
        id: extract
        working-directory: terraform-k8s-infrastructure
        run: |
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)

          echo "bastion_ip=${BASTION_IP}" >> "$GITHUB_OUTPUT"
          echo "lb_dns=${LB_DNS}" >> "$GITHUB_OUTPUT"

      - name: Save Terraform Outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          mkdir -p /tmp/terraform-outputs

          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json
          terraform output -raw ssh_private_key > /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem

      - name: Upload Terraform Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs
          retention-days: 7

      - name: Wait for EC2 Boot
        run: sleep 180

  ansible-provision:
    name: Configure Kubernetes Cluster
    runs-on: ubuntu-latest
    needs: terraform-apply

    env:
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          pip install --upgrade pip
          pip install ansible

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          cp /tmp/terraform-outputs/petclinic-test-key.pem ~/.ssh/
          chmod 400 ~/.ssh/petclinic-test-key.pem
          echo "Host *" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config

      - name: Generate Ansible Inventory
        working-directory: ansible-k8s-setup
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          MASTER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/master_ips.json)
          WORKER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/worker_ips.json)

          {
            echo "[bastion]"
            echo "bastion ansible_host=${BASTION_IP} ansible_user=ubuntu"

            echo ""
            echo "[masters]"
            i=1
            for ip in $MASTER_IPS; do
              echo "master-${i} ansible_host=${ip}"
              i=$((i+1))
            done

            echo ""
            echo "[workers]"
            i=1
            for ip in $WORKER_IPS; do
              echo "worker-${i} ansible_host=${ip}"
              i=$((i+1))
            done

            echo ""
            echo "[k8s_cluster:children]"
            echo "masters"
            echo "workers"

            echo ""
            echo "[k8s_cluster:vars]"
            echo "ansible_user=ubuntu"
            echo "ansible_python_interpreter=/usr/bin/python3"
            echo "ansible_ssh_private_key_file=~/.ssh/petclinic-test-key.pem"
            echo "ansible_ssh_common_args=-o ProxyCommand=\"ssh -W %h:%p -i ~/.ssh/petclinic-test-key.pem ubuntu@${BASTION_IP}\""
          } > inventory/hosts.ini

          sed -i "s|control_plane_endpoint:.*|control_plane_endpoint: \"${LB_DNS}:6443\"|" inventory/group_vars/all.yml

      - name: Show Inventory
        working-directory: ansible-k8s-setup
        run: cat inventory/hosts.ini

      - name: Run Ansible Playbooks
        working-directory: ansible-k8s-setup
        run: |
          ansible all -i inventory/hosts.ini -m ping
          ansible-playbook -i inventory/hosts.ini playbooks/01-verify-nodes.yml
          ansible-playbook -i inventory/hosts.ini playbooks/02-init-first-master.yml
          ansible-playbook -i inventory/hosts.ini playbooks/03-join-masters.yml
          ansible-playbook -i inventory/hosts.ini playbooks/04-join-workers.yml
          ansible-playbook -i inventory/hosts.ini playbooks/05-install-cni.yml
          ansible-playbook -i inventory/hosts.ini playbooks/06-create-namespaces.yml
          ansible-playbook -i inventory/hosts.ini playbooks/07-setup-kubectl-bastion.yml
          ansible-playbook -i inventory/hosts.ini playbooks/08-install-ingress-nginx.yml

      - name: Fetch kubeconfig
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          scp -i ~/.ssh/petclinic-test-key.pem ubuntu@$BASTION_IP:~/.kube/config /tmp/kubeconfig || true

      - name: Upload kubeconfig
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: /tmp/kubeconfig
          retention-days: 7
