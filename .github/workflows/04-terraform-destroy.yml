name: 04 - Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm deletion of all resources'
        required: true
        type: string
      
      delete_s3_bucket:
        description: 'Also delete S3 bucket'
        required: false
        type: boolean
        default: false
      
      force_cleanup:
        description: 'Force cleanup of stuck resources'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-destroy:
    name: Destroy AWS Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: âš ï¸ Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ ERROR: Destroy confirmation failed!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "You must type 'destroy' exactly to confirm."
            echo "Current input: '${{ github.event.inputs.confirm_destroy }}'"
            echo ""
            exit 1
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Destroy confirmed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ§ª Test AWS Connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª Testing AWS Connection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ğŸ›¡ï¸ Disable Termination Protection
        if: github.event.inputs.force_cleanup == 'true'
        continue-on-error: true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ›¡ï¸ Disabling Termination Protection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=petclinic-k8s" \
                      "Name=instance-state-name,Values=running,stopped" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)
          
          if [ -n "$INSTANCE_IDS" ]; then
            for INSTANCE_ID in $INSTANCE_IDS; do
              echo "Disabling protection for: $INSTANCE_ID"
              aws ec2 modify-instance-attribute \
                --instance-id $INSTANCE_ID \
                --no-disable-api-termination || true
            done
            echo "âœ… Termination protection disabled!"
          else
            echo "â„¹ï¸ No instances found"
          fi
      
      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Initializing Terraform..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform init
          echo "âœ… Init completed!"
      
      - name: ğŸ“‹ Show Resources to be Destroyed
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Resources to be destroyed:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform state list || echo "No state found"
          
          echo ""
          echo "Total resources:"
          terraform state list 2>/dev/null | wc -l || echo "0"
      
      - name: â¸ï¸ Final Confirmation
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  FINAL WARNING"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This will PERMANENTLY DELETE all infrastructure"
          echo ""
          echo "Waiting 10 seconds before proceeding..."
          sleep 10
          echo "âœ… Proceeding with destroy..."
      
      - name: ğŸ—‘ï¸ Terraform Destroy
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ—‘ï¸ Starting Terraform Destroy..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            if terraform destroy -auto-approve -input=false; then
              echo "âœ… Destroy successful!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Destroy failed, waiting 30 seconds before retry..."
                sleep 30
              else
                echo "âŒ Destroy failed after $MAX_RETRIES attempts"
                echo "Try running with 'force_cleanup' enabled"
                exit 1
              fi
            fi
          done
      
      - name: ğŸ”Œ Cleanup Stuck Resources
        if: failure() && github.event.inputs.force_cleanup == 'true'
        continue-on-error: true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Force cleaning stuck resources..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Delete available ENIs
          ENI_IDS=$(aws ec2 describe-network-interfaces \
            --filters "Name=tag:Project,Values=petclinic-k8s" \
            --query 'NetworkInterfaces[?Status==`available`].NetworkInterfaceId' \
            --output text)
          
          for ENI_ID in $ENI_IDS; do
            echo "Deleting ENI: $ENI_ID"
            aws ec2 delete-network-interface \
              --network-interface-id $ENI_ID || true
          done
          
          echo "âœ… Cleanup completed!"
      
      - name: ğŸ—‘ï¸ Delete S3 Bucket
        if: github.event.inputs.delete_s3_bucket == 'true'
        continue-on-error: true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ—‘ï¸ Deleting S3 Bucket..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BUCKET_NAME="petclinic-atos"
          
          echo "Emptying bucket..."
          aws s3 rm s3://${BUCKET_NAME} --recursive || true
          
          echo "Deleting bucket..."
          aws s3api delete-bucket \
            --bucket ${BUCKET_NAME} \
            --region ${{ env.AWS_REGION }} || true
          
          echo "âœ… S3 Bucket deleted!"
      
      - name: âœ… Destroy Complete
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Destroy Completed Successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š All resources have been destroyed"
          echo ""
          echo "ğŸ’° AWS charges will stop immediately"
          echo ""
          echo "ğŸ”„ To redeploy, run the Apply workflow"
          echo ""
