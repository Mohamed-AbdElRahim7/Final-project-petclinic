name: 02 - Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'
  
  workflow_dispatch:
    inputs:
      auto_trigger_ansible:
        description: 'Auto-trigger Ansible provisioning after apply'
        required: false
        type: boolean
        default: true

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
      actions: write
    
    outputs:
      bastion_ip: ${{ steps.outputs.outputs.bastion_ip }}
      lb_dns: ${{ steps.outputs.outputs.lb_dns }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ§ª Test AWS Connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª Testing AWS Connection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Initializing Terraform..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform init
          echo "âœ… Init completed!"
      
      - name: âœ… Terraform Validate
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Validating Configuration..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform validate
          echo "âœ… Validation passed!"
      
      - name: ğŸš€ Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ Starting Terraform Apply..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform apply -auto-approve -input=false
          echo ""
          echo "âœ… Terraform Apply Completed!"
      
      - name: ğŸ“Š Get Terraform Outputs
        id: outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Extracting Terraform Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)
          
          echo "bastion_ip=${BASTION_IP}" >> $GITHUB_OUTPUT
          echo "lb_dns=${LB_DNS}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Outputs Extracted:"
          echo "   â€¢ Bastion IP: ${BASTION_IP}"
          echo "   â€¢ Load Balancer: ${LB_DNS}"
      
      - name: ğŸ“¦ Save Outputs for Ansible
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Saving Terraform Outputs..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          mkdir -p /tmp/terraform-outputs
          
          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json
          terraform output -raw ssh_private_key > /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem
          
          echo "âœ… Outputs saved!"
          ls -lh /tmp/terraform-outputs/
      
      - name: ğŸ“¦ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs/
          retention-days: 7
      
      - name: â³ Wait for EC2 Boot
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â³ Waiting 3 minutes for EC2 boot..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          sleep 180
          echo "âœ… Wait completed!"
      
      - name: ğŸ”Œ Test Bastion SSH
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Testing Bastion connectivity..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          ssh -i /tmp/terraform-outputs/petclinic-test-key.pem \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              ubuntu@${{ steps.outputs.outputs.bastion_ip }} \
              'echo "âœ… Bastion is reachable!"' || echo "âš ï¸ Bastion not ready yet"
      
      - name: ğŸ“‹ Infrastructure Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Infrastructure Deployed!          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Details:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â€¢ Bastion IP:    ${{ steps.outputs.outputs.bastion_ip }}"
          echo "â€¢ Load Balancer: ${{ steps.outputs.outputs.lb_dns }}"
          echo "â€¢ Masters:       3 nodes"
          echo "â€¢ Workers:       3 nodes"
          echo ""
          echo "ğŸ”‘ SSH Access:"
          echo "ssh -i petclinic-test-key.pem ubuntu@${{ steps.outputs.outputs.bastion_ip }}"
          echo ""
      
      - name: ğŸš€ Trigger Ansible (Auto)
        if: github.event.inputs.auto_trigger_ansible != 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: '03-ansible-provision.yml',
                ref: 'main'
              });
              console.log('âœ… Ansible workflow triggered!');
            } catch (error) {
              console.log('âš ï¸ Failed to trigger Ansible:', error.message);
            }
