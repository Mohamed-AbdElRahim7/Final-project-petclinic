name: 04 - Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm deletion of all resources'
        required: true
        type: string
      
      delete_s3_bucket:
        description: 'Also delete S3 bucket'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-destroy:
    name: Destroy AWS Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: âš ï¸ Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "destroy" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ ERROR: Destroy confirmation failed!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "You must type 'destroy' exactly to confirm."
            echo "Current input: '${{ github.event.inputs.confirm_destroy }}'"
            echo ""
            echo "This is a safety measure to prevent accidental deletion."
            echo ""
            exit 1
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Destroy confirmed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ§ª Test AWS Connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª Testing AWS Connection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš™ï¸ Initializing Terraform..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform init
          echo "âœ… Init completed!"
      
      - name: ğŸ“‹ Show Resources to be Destroyed
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Resources to be destroyed:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          terraform state list || echo "No state found"
          
          echo ""
          echo "Total resources:"
          terraform state list | wc -l
      
      - name: â¸ï¸ Final Confirmation
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  FINAL WARNING"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This will PERMANENTLY DELETE:"
          echo "  â€¢ 1 VPC with subnets"
          echo "  â€¢ 1 Bastion host"
          echo "  â€¢ 3 Master nodes"
          echo "  â€¢ 3 Worker nodes"
          echo "  â€¢ 3 NAT Gateways"
          echo "  â€¢ 3 Elastic IPs"
          echo "  â€¢ 1 Network Load Balancer"
          echo "  â€¢ All Security Groups"
          echo "  â€¢ All EBS volumes"
          echo "  â€¢ SSH key pair"
          echo ""
          echo "Waiting 10 seconds before proceeding..."
          sleep 10
          echo "âœ… Proceeding with destroy..."
      
      - name: ğŸ—‘ï¸ Terraform Destroy
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ—‘ï¸ Starting Terraform Destroy..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          terraform destroy -auto-approve -input=false
          
          echo ""
          echo "âœ… Terraform Destroy Completed!"
      
      - name: ğŸ—‘ï¸ Delete S3 Bucket (Optional)
        if: github.event.inputs.delete_s3_bucket == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ—‘ï¸ Deleting S3 Bucket..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          BUCKET_NAME="petclinic-atos"
          
          # Empty bucket first
          echo "Emptying bucket..."
          aws s3 rm s3://${BUCKET_NAME} --recursive || echo "Bucket already empty"
          
          # Delete bucket
          echo "Deleting bucket..."
          aws s3api delete-bucket --bucket ${BUCKET_NAME} --region ${{ env.AWS_REGION }} || echo "Bucket already deleted"
          
          echo "âœ… S3 Bucket deleted!"
      
      - name: ğŸ§¹ Clean Local State
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§¹ Cleaning local state files..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          rm -f terraform.tfstate
          rm -f terraform.tfstate.backup
          rm -f .terraform.lock.hcl
          rm -rf .terraform/
          
          echo "âœ… Local state cleaned!"
      
      - name: ğŸ§¹ Delete Old Artifacts (Optional)
        continue-on-error: true
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§¹ Note: Old artifacts will expire automatically"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Artifacts are kept for 7 days by default"
          echo "You can manually delete them from:"
          echo "  Actions â†’ Select workflow run â†’ Delete"
      
      - name: âœ… Destroy Complete
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Destroy Completed Successfully!   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Destroyed Resources:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… All EC2 instances deleted"
          echo "  âœ… VPC and networking deleted"
          echo "  âœ… Load balancers deleted"
          echo "  âœ… Security groups deleted"
          echo "  âœ… EBS volumes deleted"
          echo "  âœ… SSH key pair deleted"
          if [ "${{ github.event.inputs.delete_s3_bucket }}" == "true" ]; then
            echo "  âœ… S3 bucket deleted"
          fi
          echo ""
          echo "ğŸ’° Cost Impact:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  â€¢ AWS charges will stop immediately"
          echo "  â€¢ No more EC2 hourly charges"
          echo "  â€¢ No more NAT Gateway charges"
          echo "  â€¢ No more EBS storage charges"
          echo ""
          echo "ğŸ”„ To redeploy:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  1. Run '02 - Terraform Apply' workflow"
          echo "  2. Wait ~10 minutes"
          echo "  3. Cluster will be recreated"
          echo ""
