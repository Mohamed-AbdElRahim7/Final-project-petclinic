---
- name: Install Calico CNI
  hosts: first_master
  become: true
  gather_facts: true

  vars:
    calico_version: "v3.27.0"
    pod_network_cidr: "192.168.0.0/16"

  tasks:
    - name: Check if Calico pods exist
      ansible.builtin.shell: |
        kubectl get pods -n kube-system -l k8s-app=calico-node --no-headers 2>/dev/null | wc -l
      register: calico_pods_count
      changed_when: false
      failed_when: false

    - name: Display Calico check status
      ansible.builtin.debug:
        msg: "Calico pods found: {{ calico_pods_count.stdout }}"

    - name: Set installation flag
      ansible.builtin.set_fact:
        need_install: "{{ calico_pods_count.stdout | int == 0 }}"

    - name: Download Calico manifest
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/calico.yaml"
        dest: /tmp/calico.yaml
        mode: '0644'
      when: need_install

    - name: Modify Calico manifest for pod network CIDR
      ansible.builtin.replace:
        path: /tmp/calico.yaml
        regexp: '192.168.0.0/16'
        replace: "{{ pod_network_cidr }}"
      when: need_install

    - name: Apply Calico manifest
      ansible.builtin.shell: |
        kubectl apply -f /tmp/calico.yaml
      register: calico_apply
      changed_when: true
      when: need_install

    - name: Display Calico installation output
      ansible.builtin.debug:
        msg: "{{ calico_apply.stdout_lines }}"
      when: need_install and calico_apply.stdout_lines is defined

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "  Calico CNI Installation Complete!"
          - "=========================================="
          - ""
          - "Calico Version: {{ calico_version }}"
          - "Pod Network CIDR: {{ pod_network_cidr }}"
          - ""
          - "IMPORTANT: Calico is installing in background"
          - "This takes 2-3 minutes to fully activate"
          - ""
          - "To verify manually:"
          - "1. SSH to bastion"
          - "2. Run: kubectl get pods -n kube-system | grep calico"
          - "3. Wait until all pods are Running"
          - "4. Run: kubectl get nodes (should show Ready)"
          - ""
          - "The playbook will continue to next steps..."
