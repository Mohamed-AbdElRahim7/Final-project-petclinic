name: 03 - Ansible Provision

on:
  workflow_dispatch:
    inputs:
      skip_verification:
        description: 'Skip node verification'
        required: false
        type: boolean
        default: false
  
  workflow_run:
    workflows: ["02 - Terraform Apply"]
    types:
      - completed
    branches:
      - main

env:
  ANSIBLE_HOST_KEY_CHECKING: 'False'
  AWS_REGION: 'us-east-1'

jobs:
  ansible-provision:
    name: Setup Kubernetes Cluster
    runs-on: ubuntu-latest
    
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install Ansible
        run: |
          echo "========================================"
          echo "Installing Ansible..."
          echo "========================================"
          
          pip install --upgrade pip setuptools wheel
          pip install ansible-core
          
          echo ""
          echo "Ansible installed:"
          ansible --version
      
      - name: ðŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ðŸ“¥ Download Terraform Outputs
        id: download_artifacts
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs
        continue-on-error: true
      
      - name: âŒ Check Artifacts
        if: steps.download_artifacts.outcome == 'failure'
        run: |
          echo "========================================"
          echo "ERROR: Terraform outputs not found!"
          echo "========================================"
          echo ""
          echo "This means one of the following:"
          echo "1. 02-terraform-apply.yml didn't run yet"
          echo "2. 02-terraform-apply.yml failed"
          echo "3. Artifacts expired (7 days retention)"
          echo ""
          echo "How to fix:"
          echo "1. Go to Actions tab"
          echo "2. Run '02 - Terraform Apply' workflow"
          echo "3. Wait for it to complete (~10 min)"
          echo "4. This workflow will auto-trigger"
          echo ""
          echo "Or manually trigger after Apply succeeds."
          echo ""
          exit 1
      
      - name: âœ… Verify Artifacts
        run: |
          echo "========================================"
          echo "Verifying downloaded artifacts..."
          echo "========================================"
          
          if [ ! -d "/tmp/terraform-outputs" ]; then
            echo "Artifacts directory not found!"
            exit 1
          fi
          
          echo "Artifacts found:"
          ls -lh /tmp/terraform-outputs/
          
          REQUIRED_FILES=(
            "bastion_ip.txt"
            "lb_dns.txt"
            "master_ips.json"
            "worker_ips.json"
            "petclinic-test-key.pem"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "/tmp/terraform-outputs/$file" ]; then
              echo "Missing required file: $file"
              exit 1
            fi
            echo "  $file"
          done
          
          echo ""
          echo "All artifacts verified!"
      
      - name: ðŸ”‘ Setup SSH Key
        run: |
          echo "========================================"
          echo "Setting up SSH..."
          echo "========================================"
          
          mkdir -p ~/.ssh
          cp /tmp/terraform-outputs/petclinic-test-key.pem ~/.ssh/
          chmod 400 ~/.ssh/petclinic-test-key.pem
          
          cat >> ~/.ssh/config <<EOF
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          echo "SSH configured!"
      
      - name: ðŸ“ Generate Inventory
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Generating Inventory..."
          echo "========================================"
          
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          
          MASTER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/master_ips.json | paste -sd ' ')
          WORKER_IPS=$(jq -r '.[]' /tmp/terraform-outputs/worker_ips.json | paste -sd ' ')
          
          echo "Debug Info:"
          echo "  Bastion: $BASTION_IP"
          echo "  LB: $LB_DNS"
          echo "  Masters: $MASTER_IPS"
          echo "  Workers: $WORKER_IPS"
          
          if [ -z "$BASTION_IP" ] || [ -z "$LB_DNS" ] || [ -z "$MASTER_IPS" ] || [ -z "$WORKER_IPS" ]; then
            echo "Error: Missing required outputs!"
            exit 1
          fi
          
          cat > inventory/hosts.ini <<EOF
          # ============================================
          # Kubernetes Cluster Inventory
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # ============================================
          
          [bastion]
          bastion ansible_host=$BASTION_IP ansible_user=ubuntu
          
          [masters]
          EOF
          
          MASTER_INDEX=1
          for IP in $MASTER_IPS; do
              echo "master-$MASTER_INDEX ansible_host=$IP node_type=master node_index=$MASTER_INDEX" >> inventory/hosts.ini
              MASTER_INDEX=$((MASTER_INDEX + 1))
          done
          
          cat >> inventory/hosts.ini <<EOF
          
          [workers]
          EOF
          
          WORKER_INDEX=1
          for IP in $WORKER_IPS; do
              echo "worker-$WORKER_INDEX ansible_host=$IP node_type=worker node_index=$WORKER_INDEX" >> inventory/hosts.ini
              WORKER_INDEX=$((WORKER_INDEX + 1))
          done
          
          cat >> inventory/hosts.ini <<'EOF'
          
          [first_master]
          master-1
          
          [other_masters]
          master-2
          master-3
          
          [k8s_cluster:children]
          masters
          workers
          
          [all:children]
          bastion
          k8s_cluster
          
          [k8s_cluster:vars]
          ansible_user=ubuntu
          ansible_ssh_private_key_file=~/.ssh/petclinic-test-key.pem
          ansible_python_interpreter=/usr/bin/python3
          EOF
          
          cat >> inventory/hosts.ini <<EOF
          ansible_ssh_common_args='-o ProxyCommand="ssh -W %h:%p -i ~/.ssh/petclinic-test-key.pem -o StrictHostKeyChecking=no ubuntu@$BASTION_IP"'
          
          [masters:vars]
          k8s_role=master
          
          [workers:vars]
          k8s_role=worker
          
          [bastion:vars]
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF
          
          sed -i "s|control_plane_endpoint:.*|control_plane_endpoint: \"$LB_DNS:6443\"|" inventory/group_vars/all.yml
          
          echo ""
          echo "Inventory generated successfully!"
      
      - name: ðŸ‘ï¸ Show Inventory
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Generated Inventory:"
          echo "========================================"
          cat inventory/hosts.ini
      
      - name: â³ Wait for Nodes
        run: |
          echo "========================================"
          echo "Waiting for user-data scripts..."
          echo "========================================"
          echo "This takes ~2 minutes for EC2 to:"
          echo "  - Run user-data scripts"
          echo "  - Install Kubernetes components"
          echo "  - Configure networking"
          echo ""
          sleep 120
          echo "Wait completed!"
      
      - name: ðŸ”Œ Test Connectivity
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Testing SSH connectivity..."
          echo "========================================"
          
          ansible all -i inventory/hosts.ini -m ping || echo "Some nodes not ready yet"
      
      - name: "âœ… Step 1/8: Verify Nodes"
        if: github.event.inputs.skip_verification != 'true'
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 1/8: Verify Nodes"
          echo "========================================"
          ansible-playbook playbooks/01-verify-nodes.yml -i inventory/hosts.ini
      
      - name: "ðŸŽ¯ Step 2/8: Init First Master"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 2/8: Initialize First Master"
          echo "========================================"
          ansible-playbook playbooks/02-init-first-master.yml -i inventory/hosts.ini
      
      - name: "ðŸ”— Step 3/8: Join Masters"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 3/8: Join Other Masters"
          echo "========================================"
          ansible-playbook playbooks/03-join-masters.yml -i inventory/hosts.ini
      
      - name: "ðŸ‘· Step 4/8: Join Workers"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 4/8: Join Workers"
          echo "========================================"
          ansible-playbook playbooks/04-join-workers.yml -i inventory/hosts.ini
      
      - name: "ðŸŒ Step 5/8: Install CNI"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 5/8: Install Calico CNI"
          echo "========================================"
          ansible-playbook playbooks/05-install-cni.yml -i inventory/hosts.ini
      
      - name: "ðŸ“¦ Step 6/8: Create Namespaces"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 6/8: Create Namespaces"
          echo "========================================"
          ansible-playbook playbooks/06-create-namespaces.yml -i inventory/hosts.ini
      
      - name: "ðŸ–¥ï¸ Step 7/8: Setup Kubectl"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 7/8: Setup kubectl on Bastion"
          echo "========================================"
          ansible-playbook playbooks/07-setup-kubectl-bastion.yml -i inventory/hosts.ini
      
      - name: "ðŸ”€ Step 8/8: Install Ingress"
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Step 8/8: Install Ingress Controller"
          echo "========================================"
          ansible-playbook playbooks/08-install-ingress-nginx.yml -i inventory/hosts.ini
      
      - name: ðŸ“¥ Get Kubeconfig
        working-directory: ansible-k8s-setup
        run: |
          echo "========================================"
          echo "Fetching kubeconfig..."
          echo "========================================"
          
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          
          scp -i ~/.ssh/petclinic-test-key.pem \
              -o StrictHostKeyChecking=no \
              ubuntu@${BASTION_IP}:~/.kube/config \
              /tmp/kubeconfig || echo "Failed to fetch kubeconfig"
      
      - name: ðŸ“¦ Upload Kubeconfig
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: /tmp/kubeconfig
          retention-days: 7
      
      - name: ðŸŽ‰ Success Summary
        run: |
          BASTION_IP=$(cat /tmp/terraform-outputs/bastion_ip.txt)
          LB_DNS=$(cat /tmp/terraform-outputs/lb_dns.txt)
          
          echo ""
          echo "========================================"
          echo "  Cluster Setup Complete!"
          echo "========================================"
          echo ""
          echo "Cluster Info:"
          echo "----------------------------------------"
          echo "Bastion:  $BASTION_IP"
          echo "API:      $LB_DNS:6443"
          echo "Masters:  3"
          echo "Workers:  3"
          echo ""
          echo "SSH Access:"
          echo "ssh -i petclinic-test-key.pem ubuntu@$BASTION_IP"
          echo ""
          echo "Artifacts:"
          echo "- terraform-outputs"
          echo "- kubeconfig"
          echo ""
          echo "Next Steps:"
          echo "1. Download kubeconfig artifact"
          echo "2. export KUBECONFIG=./kubeconfig"
          echo "3. kubectl get nodes"
          echo ""
