name: 02 - Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform-k8s-infrastructure/**'
  
  workflow_dispatch:
    inputs:
      auto_trigger_ansible:
        description: 'Auto-trigger Ansible provisioning after apply'
        required: false
        type: boolean
        default: true

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'

jobs:
  terraform-apply:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
      actions: write
    
    outputs:
      bastion_ip: ${{ steps.outputs.outputs.bastion_ip }}
      lb_dns: ${{ steps.outputs.outputs.lb_dns }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ§ª Test AWS Connection
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª Testing AWS Connection..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: âš™ï¸ Terraform Init
        working-directory: terraform-k8s-infrastructure
        run: terraform init
      
      - name: âœ… Terraform Validate
        working-directory: terraform-k8s-infrastructure
        run: terraform validate
      
      - name: ğŸš€ Terraform Apply
        working-directory: terraform-k8s-infrastructure
        run: terraform apply -auto-approve -input=false
      
      - name: ğŸ“Š Get Terraform Outputs
        id: outputs
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "Extracting outputs..."

          BASTION_IP=$(terraform output -raw bastion_public_ip)
          LB_DNS=$(terraform output -raw master_load_balancer_dns)

          echo "bastion_ip=${BASTION_IP}" >> $GITHUB_OUTPUT
          echo "lb_dns=${LB_DNS}" >> $GITHUB_OUTPUT

          echo "âœ” Bastion: ${BASTION_IP}"
          echo "âœ” LB DNS: ${LB_DNS}"
      
      - name: ğŸ“¦ Save Outputs for Ansible
        working-directory: terraform-k8s-infrastructure
        run: |
          echo "Saving Terraform Outputs..."

          mkdir -p /tmp/terraform-outputs

          terraform output -raw bastion_public_ip > /tmp/terraform-outputs/bastion_ip.txt
          terraform output -raw master_load_balancer_dns > /tmp/terraform-outputs/lb_dns.txt
          terraform output -json master_private_ips > /tmp/terraform-outputs/master_ips.json
          terraform output -json worker_private_ips > /tmp/terraform-outputs/worker_ips.json

          # Copy the private key generated locally by Terraform
          cp petclinic-test-key.pem /tmp/terraform-outputs/petclinic-test-key.pem
          chmod 400 /tmp/terraform-outputs/petclinic-test-key.pem

          echo "Files saved:"
          ls -lh /tmp/terraform-outputs/
      
      - name: ğŸ“¦ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp/terraform-outputs/
          retention-days: 7
      
      - name: â³ Wait for EC2 Boot
        run: sleep 180
      
      - name: ğŸ”Œ Test Bastion SSH
        run: |
          echo "Testing SSH..."
          ssh -i /tmp/terraform-outputs/petclinic-test-key.pem \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=30 \
              ubuntu@${{ steps.outputs.outputs.bastion_ip }} \
              'echo OK' || echo "âš ï¸ Bastion not ready yet"
      
      - name: ğŸ“‹ Infrastructure Summary
        run: |
          echo ""
          echo "Infrastructure Deployed!"
          echo "Bastion: ${{ steps.outputs.outputs.bastion_ip }}"
          echo "LB DNS: ${{ steps.outputs.outputs.lb_dns }}"
          echo ""
      
      - name: ğŸš€ Trigger Ansible (Auto)
        if: github.event.inputs.auto_trigger_ansible != 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '03-ansible-provision.yml',
              ref: 'main'
            });
            console.log('Ansible workflow triggered!');
