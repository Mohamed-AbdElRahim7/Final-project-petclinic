---
- name: Join Workers to Cluster
  hosts: workers
  become: true
  gather_facts: true
  serial: 1

  tasks:
    - name: Check if node is already joined
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/kubelet.conf get nodes 2>/dev/null | grep -q "{{ inventory_hostname }}" && echo "joined" || echo "not_joined"
      register: node_status
      changed_when: false
      failed_when: false

    - name: Display join status
      ansible.builtin.debug:
        msg: "Node {{ ansible_hostname }} is {{ 'already joined' if 'joined' in node_status.stdout else 'NOT joined' }}"

    - name: Skip if already joined
      ansible.builtin.meta: end_host
      when: "'joined' in node_status.stdout"

    - name: Generate new join token on first master
      ansible.builtin.shell: |
        kubeadm token create --print-join-command
      register: join_command
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Display join command
      ansible.builtin.debug:
        msg: "{{ join_command.stdout }}"

    - name: Join worker to cluster
      ansible.builtin.shell: |
        {{ join_command.stdout }}
      register: join_result
      async: 600
      poll: 10
      retries: 3
      delay: 10
      until: join_result.rc == 0
      changed_when: true

    - name: Wait for node to be ready
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get node {{ ansible_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      register: node_ready
      until: node_ready.stdout == "True"
      retries: 30
      delay: 10
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Label worker node
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf label node {{ ansible_hostname }} node-role.kubernetes.io/worker='' --overwrite
      delegate_to: "{{ groups['first_master'][0] }}"
      changed_when: true

    - name: Verify worker joined successfully
      ansible.builtin.shell: |
        kubectl --kubeconfig=/etc/kubernetes/admin.conf get nodes {{ ansible_hostname }} -o wide
      register: verify_join
      changed_when: false
      delegate_to: "{{ groups['first_master'][0] }}"

    - name: Display verification
      ansible.builtin.debug:
        msg: "{{ verify_join.stdout_lines }}"
